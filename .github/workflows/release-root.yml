name: Build all subpackages and create namespace release

on:
  push:
    paths:
      - 'pyproject.toml'
  workflow_dispatch: {}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      diffs: ${{ steps.setouts.outputs.diffs }}
    steps:
      - name: Checkout full history
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch origin/main
        run: git fetch origin main:origin-main || true

      - name: Compute version diffs
        id: setouts
        run: |
          python ./scripts/compute_diffs.py

  backup:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).backup_changed == 'true' }}
    uses: ./.github/workflows/backup/release.yml

  backup-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).backup_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for backup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "backup/release.yml" "backup-${{ fromJson(needs.prepare.outputs.diffs).backup_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/backup || true

  color:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).color_changed == 'true' }}
    uses: ./.github/workflows/color/release.yml

  color-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).color_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for color
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "color/release.yml" "color-${{ fromJson(needs.prepare.outputs.diffs).color_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/color || true

  config:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).config_changed == 'true' }}
    uses: ./.github/workflows/config/release.yml

  config-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).config_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "config/release.yml" "config-${{ fromJson(needs.prepare.outputs.diffs).config_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/config || true

  examples:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).examples_changed == 'true' }}
    uses: ./.github/workflows/examples/release.yml

  examples-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).examples_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for examples
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "examples/release.yml" "examples-${{ fromJson(needs.prepare.outputs.diffs).examples_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/examples || true

  log:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).log_changed == 'true' }}
    uses: ./.github/workflows/log/release.yml

  log-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).log_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "log/release.yml" "log-${{ fromJson(needs.prepare.outputs.diffs).log_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/log || true

  rainbow:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).rainbow_changed == 'true' }}
    uses: ./.github/workflows/rainbow/release.yml

  rainbow-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).rainbow_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for rainbow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "rainbow/release.yml" "rainbow-${{ fromJson(needs.prepare.outputs.diffs).rainbow_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/rainbow || true

  sentinel:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).sentinel_changed == 'true' }}
    uses: ./.github/workflows/sentinel/release.yml

  sentinel-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).sentinel_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for sentinel
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "sentinel/release.yml" "sentinel-${{ fromJson(needs.prepare.outputs.diffs).sentinel_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/sentinel || true

  tree:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).tree_changed == 'true' }}
    uses: ./.github/workflows/tree/release.yml

  tree-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).tree_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download latest artifact for tree
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/download_artifact.sh ./scripts/unpack_artifacts.sh || true
          ./scripts/download_artifact.sh "tree/release.yml" "tree-${{ fromJson(needs.prepare.outputs.diffs).tree_version }}" artifacts || true
          ./scripts/unpack_artifacts.sh artifacts dist/tree || true

  build-namespace:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - backup
      - backup-fetch
      - color
      - color-fetch
      - config
      - config-fetch
      - examples
      - examples-fetch
      - log
      - log-fetch
      - rainbow
      - rainbow-fetch
      - sentinel
      - sentinel-fetch
      - tree
      - tree-fetch
    if: ${{ fromJson(needs.prepare.outputs.diffs).root_changed == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Gather artifacts
        run: |
          chmod +x ./scripts/gather_namespace_artifacts.sh || true
          ./scripts/gather_namespace_artifacts.sh

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Build namespace package
        run: |
          uv python install || true
          uv build

      - name: Create GitHub release with built artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: dist/** namespace_dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
