name: Build all subpackages and create namespace release

on:
  push:
    paths:
      - 'pyproject.toml'
  workflow_dispatch: {}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      diffs: ${{ steps.setouts.outputs.diffs }}
    steps:
      - name: Checkout full history
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Fetch origin/main
        run: git fetch origin main:origin-main || true

      - name: Compute version diffs
        id: setouts
        run: |
          python ./scripts/compute_diffs.py

  backup:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).backup_changed == 'true' }}
    uses: ./.github/workflows/backup/release.yml

  backup-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).backup_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch backup artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: backup
          version: ${{ fromJson(needs.prepare.outputs.diffs).backup_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  color:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).color_changed == 'true' }}
    uses: ./.github/workflows/color/release.yml

  color-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).color_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch color artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: color
          version: ${{ fromJson(needs.prepare.outputs.diffs).color_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  config:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).config_changed == 'true' }}
    uses: ./.github/workflows/config/release.yml

  config-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).config_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch config artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: config
          version: ${{ fromJson(needs.prepare.outputs.diffs).config_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  examples:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).examples_changed == 'true' }}
    uses: ./.github/workflows/examples/release.yml

  examples-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).examples_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch examples artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: examples
          version: ${{ fromJson(needs.prepare.outputs.diffs).examples_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  log:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).log_changed == 'true' }}
    uses: ./.github/workflows/log/release.yml

  log-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).log_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch log artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: log
          version: ${{ fromJson(needs.prepare.outputs.diffs).log_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  rainbow:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).rainbow_changed == 'true' }}
    uses: ./.github/workflows/rainbow/release.yml

  rainbow-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).rainbow_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch rainbow artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: rainbow
          version: ${{ fromJson(needs.prepare.outputs.diffs).rainbow_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  sentinel:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).sentinel_changed == 'true' }}
    uses: ./.github/workflows/sentinel/release.yml

  sentinel-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).sentinel_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch sentinel artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: sentinel
          version: ${{ fromJson(needs.prepare.outputs.diffs).sentinel_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  tree:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).tree_changed == 'true' }}
    uses: ./.github/workflows/tree/release.yml

  tree-fetch:
    needs: prepare
    if: ${{ fromJson(needs.prepare.outputs.diffs).tree_changed == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch tree artifact
        uses: ./.github/actions/fetch-subpackage-artifact
        with:
          subpackage: tree
          version: ${{ fromJson(needs.prepare.outputs.diffs).tree_version }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-namespace:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - backup
      - backup-fetch
      - color
      - color-fetch
      - config
      - config-fetch
      - examples
      - examples-fetch
      - log
      - log-fetch
      - rainbow
      - rainbow-fetch
      - sentinel
      - sentinel-fetch
      - tree
      - tree-fetch
    if: ${{ fromJson(needs.prepare.outputs.diffs).root_changed == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Gather artifacts
        run: |
          chmod +x ./scripts/gather_namespace_artifacts.sh || true
          ./scripts/gather_namespace_artifacts.sh

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Build namespace package
        run: |
          uv python install || true
          uv build

      - name: Create GitHub release with built artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: dist/** namespace_dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
